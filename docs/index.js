/*!
* Signature Pad v5.1.1 | https://github.com/szimek/signature_pad
* (c) 2025 Szymon Nowak | Released under the MIT license
*/var playPanel,infoPanel,countPanel,scorePanel,tegakiPanel,canvasCache,canvases,gameTime,emojiParticle,correctCount,pads,problems,answered,answer,firstRun,audioContext,audioBufferCache,japaneseVoices,gameTimer,TegakiBox,globalCSS,worker,t=class{x;y;pressure;time;constructor(e,t,n,s){if(isNaN(e)||isNaN(t))throw new Error(`Point is invalid: (${e}, ${t})`);this.x=+e,this.y=+t,this.pressure=n||0,this.time=s||Date.now()}distanceTo(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))}equals(e){return this.x===e.x&&this.y===e.y&&this.pressure===e.pressure&&this.time===e.time}velocityFrom(e){return this.time!==e.time?this.distanceTo(e)/(this.time-e.time):0}},e=class e2{constructor(e,t,n,s,o,i){this.startPoint=e,this.control2=t,this.control1=n,this.endPoint=s,this.startWidth=o,this.endWidth=i}static fromPoints(e,t){const n=this.calculateControlPoints(e[0],e[1],e[2]).c2,s=this.calculateControlPoints(e[1],e[2],e[3]).c1;return new e2(e[1],n,s,e[2],t.start,t.end)}static calculateControlPoints(e,n,s){const m=e.x-n.x,d=e.y-n.y,h=n.x-s.x,u=n.y-s.y,c=(e.x+n.x)/2,l=(e.y+n.y)/2,a=(n.x+s.x)/2,i=(n.y+s.y)/2,r=Math.sqrt(m*m+d*d),o=Math.sqrt(h*h+u*u),f=r+o==0?0:o/(r+o),v=a+(c-a)*f,b=i+(l-i)*f,p=n.x-v,g=n.y-b;return{c1:new t(c+p,l+g),c2:new t(a+p,i+g)}}length(){let e,t,n=0;for(let s=0;s<=10;s+=1){const o=s/10,i=this.point(o,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),a=this.point(o,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y);if(s>0){const s=i-e,o=a-t;n+=Math.sqrt(s*s+o*o)}e=i,t=a}return n}point(e,t,n,s,o){return t*(1-e)*(1-e)*(1-e)+3*n*(1-e)*(1-e)*e+3*s*(1-e)*e*e+o*e*e*e}},i=class{_et;constructor(){try{this._et=new EventTarget}catch{this._et=document}}addEventListener(e,t,n){this._et.addEventListener(e,t,n)}dispatchEvent(e){return this._et.dispatchEvent(e)}removeEventListener(e,t,n){this._et.removeEventListener(e,t,n)}},s=class s2 extends i{constructor(e,t={}){super(),this.canvas=e,this.velocityFilterWeight=t.velocityFilterWeight||.7,this.minWidth=t.minWidth||.5,this.maxWidth=t.maxWidth||2.5,this.throttle=t.throttle??16,this.minDistance=t.minDistance??5,this.dotSize=t.dotSize||0,this.penColor=t.penColor||"black",this.backgroundColor=t.backgroundColor||"rgba(0,0,0,0)",this.compositeOperation=t.compositeOperation||"source-over",this.canvasContextOptions=t.canvasContextOptions??{},this._strokeMoveUpdate=this.throttle?function(e,t=250){let i,s,o,a=0,n=null;const r=()=>{a=Date.now(),n=null,i=e.apply(s,o),n||(s=null,o=[])};return function(...d){const l=Date.now(),c=t-(l-a);return s=this,o=d,c<=0||c>t?(n&&(clearTimeout(n),n=null),a=l,i=e.apply(s,o),n||(s=null,o=[])):n||(n=window.setTimeout(r,c)),i}}(s2.prototype._strokeUpdate,this.throttle):s2.prototype._strokeUpdate,this._handleMouseDown=this._handleMouseDown.bind(this),this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this._handleTouchStart=this._handleTouchStart.bind(this),this._handleTouchMove=this._handleTouchMove.bind(this),this._handleTouchEnd=this._handleTouchEnd.bind(this),this._handlePointerDown=this._handlePointerDown.bind(this),this._handlePointerMove=this._handlePointerMove.bind(this),this._handlePointerUp=this._handlePointerUp.bind(this),this._ctx=e.getContext("2d",this.canvasContextOptions),this.clear(),this.on()}dotSize;minWidth;maxWidth;penColor;minDistance;velocityFilterWeight;compositeOperation;backgroundColor;throttle;canvasContextOptions;_ctx;_drawingStroke=!1;_isEmpty=!0;_dataUrl;_dataUrlOptions;_lastPoints=[];_data=[];_lastVelocity=0;_lastWidth=0;_strokeMoveUpdate;_strokePointerId;clear(){const{_ctx:t,canvas:e}=this;t.fillStyle=this.backgroundColor,t.clearRect(0,0,e.width,e.height),t.fillRect(0,0,e.width,e.height),this._data=[],this._reset(this._getPointGroupOptions()),this._isEmpty=!0,this._dataUrl=void 0,this._dataUrlOptions=void 0,this._strokePointerId=void 0}redraw(){const t=this._data,e=this._dataUrl,n=this._dataUrlOptions;this.clear(),e&&this.fromDataURL(e,n),this.fromData(t,{clear:!1})}fromDataURL(e,t={}){return new Promise((n,s)=>{const o=new Image,i=t.ratio||window.devicePixelRatio||1,a=t.width||this.canvas.width/i,r=t.height||this.canvas.height/i,c=t.xOffset||0,l=t.yOffset||0;this._reset(this._getPointGroupOptions()),o.onload=()=>{this._ctx.drawImage(o,c,l,a,r),n()},o.onerror=e=>{s(e)},o.crossOrigin="anonymous",o.src=e,this._isEmpty=!1,this._dataUrl=e,this._dataUrlOptions={...t}})}toDataURL(e="image/png",t){return"image/svg+xml"===e?("object"!=typeof t&&(t=void 0),`data:image/svg+xml;base64,${btoa(this.toSVG(t))}`):("number"!=typeof t&&(t=void 0),this.canvas.toDataURL(e,t))}on(){this.canvas.style.touchAction="none",this.canvas.style.msTouchAction="none",this.canvas.style.userSelect="none";const e=/Macintosh/.test(navigator.userAgent)&&"ontouchstart"in document;window.PointerEvent&&!e?this._handlePointerEvents():(this._handleMouseEvents(),"ontouchstart"in window&&this._handleTouchEvents())}off(){this.canvas.style.touchAction="auto",this.canvas.style.msTouchAction="auto",this.canvas.style.userSelect="auto",this.canvas.removeEventListener("pointerdown",this._handlePointerDown),this.canvas.removeEventListener("mousedown",this._handleMouseDown),this.canvas.removeEventListener("touchstart",this._handleTouchStart),this._removeMoveUpEventListeners()}_getListenerFunctions(){const e=window.document===this.canvas.ownerDocument?window:this.canvas.ownerDocument.defaultView??this.canvas.ownerDocument;return{addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e)}}_removeMoveUpEventListeners(){const{removeEventListener:e}=this._getListenerFunctions();e("pointermove",this._handlePointerMove),e("pointerup",this._handlePointerUp),e("mousemove",this._handleMouseMove),e("mouseup",this._handleMouseUp),e("touchmove",this._handleTouchMove),e("touchend",this._handleTouchEnd)}isEmpty(){return this._isEmpty}fromData(e,{clear:t=!0}={}){t&&this.clear(),this._fromData(e,this._drawCurve.bind(this),this._drawDot.bind(this)),this._data=this._data.concat(e)}toData(){return this._data}_isLeftButtonPressed(e,t){return t?1===e.buttons:!(1&~e.buttons)}_pointerEventToSignatureEvent(e){return{event:e,type:e.type,x:e.clientX,y:e.clientY,pressure:"pressure"in e?e.pressure:0}}_touchEventToSignatureEvent(e){const t=e.changedTouches[0];return{event:e,type:e.type,x:t.clientX,y:t.clientY,pressure:t.force}}_handleMouseDown(e){this._isLeftButtonPressed(e,!0)&&!this._drawingStroke&&this._strokeBegin(this._pointerEventToSignatureEvent(e))}_handleMouseMove(e){this._isLeftButtonPressed(e,!0)&&this._drawingStroke?this._strokeMoveUpdate(this._pointerEventToSignatureEvent(e)):this._strokeEnd(this._pointerEventToSignatureEvent(e),!1)}_handleMouseUp(e){this._isLeftButtonPressed(e)||this._strokeEnd(this._pointerEventToSignatureEvent(e))}_handleTouchStart(e){1!==e.targetTouches.length||this._drawingStroke||(e.cancelable&&e.preventDefault(),this._strokeBegin(this._touchEventToSignatureEvent(e)))}_handleTouchMove(e){1===e.targetTouches.length&&(e.cancelable&&e.preventDefault(),this._drawingStroke?this._strokeMoveUpdate(this._touchEventToSignatureEvent(e)):this._strokeEnd(this._touchEventToSignatureEvent(e),!1))}_handleTouchEnd(e){0===e.targetTouches.length&&(e.cancelable&&e.preventDefault(),this._strokeEnd(this._touchEventToSignatureEvent(e)))}_getPointerId(e){return e.persistentDeviceId||e.pointerId}_allowPointerId(e,t=!1){return void 0===this._strokePointerId?t:this._getPointerId(e)===this._strokePointerId}_handlePointerDown(e){!this._drawingStroke&&this._isLeftButtonPressed(e)&&this._allowPointerId(e,!0)&&(this._strokePointerId=this._getPointerId(e),e.preventDefault(),this._strokeBegin(this._pointerEventToSignatureEvent(e)))}_handlePointerMove(e){this._allowPointerId(e)&&(this._isLeftButtonPressed(e,!0)&&this._drawingStroke?(e.preventDefault(),this._strokeMoveUpdate(this._pointerEventToSignatureEvent(e))):this._strokeEnd(this._pointerEventToSignatureEvent(e),!1))}_handlePointerUp(e){!this._isLeftButtonPressed(e)&&this._allowPointerId(e)&&(e.preventDefault(),this._strokeEnd(this._pointerEventToSignatureEvent(e)))}_getPointGroupOptions(e){return{penColor:e&&"penColor"in e?e.penColor:this.penColor,dotSize:e&&"dotSize"in e?e.dotSize:this.dotSize,minWidth:e&&"minWidth"in e?e.minWidth:this.minWidth,maxWidth:e&&"maxWidth"in e?e.maxWidth:this.maxWidth,velocityFilterWeight:e&&"velocityFilterWeight"in e?e.velocityFilterWeight:this.velocityFilterWeight,compositeOperation:e&&"compositeOperation"in e?e.compositeOperation:this.compositeOperation}}_strokeBegin(e){if(!this.dispatchEvent(new CustomEvent("beginStroke",{detail:e,cancelable:!0})))return;const{addEventListener:t}=this._getListenerFunctions();switch(e.event.type){case"mousedown":t("mousemove",this._handleMouseMove,{passive:!1}),t("mouseup",this._handleMouseUp,{passive:!1});break;case"touchstart":t("touchmove",this._handleTouchMove,{passive:!1}),t("touchend",this._handleTouchEnd,{passive:!1});break;case"pointerdown":t("pointermove",this._handlePointerMove,{passive:!1}),t("pointerup",this._handlePointerUp,{passive:!1})}this._drawingStroke=!0;const n=this._getPointGroupOptions(),s={...n,points:[]};this._data.push(s),this._reset(n),this._strokeUpdate(e)}_strokeUpdate(e){if(!this._drawingStroke)return;if(0===this._data.length)return void this._strokeBegin(e);this.dispatchEvent(new CustomEvent("beforeUpdateStroke",{detail:e}));const t=this._createPoint(e.x,e.y,e.pressure),i=this._data[this._data.length-1],s=i.points,n=s.length>0&&s[s.length-1],a=!!n&&t.distanceTo(n)<=this.minDistance,o=this._getPointGroupOptions(i);if(!n||!n||!a){const e=this._addPoint(t,o);n?e&&this._drawCurve(e,o):this._drawDot(t,o),s.push({time:t.time,x:t.x,y:t.y,pressure:t.pressure})}this.dispatchEvent(new CustomEvent("afterUpdateStroke",{detail:e}))}_strokeEnd(e,t=!0){this._removeMoveUpEventListeners(),this._drawingStroke&&(t&&this._strokeUpdate(e),this._drawingStroke=!1,this._strokePointerId=void 0,this.dispatchEvent(new CustomEvent("endStroke",{detail:e})))}_handlePointerEvents(){this._drawingStroke=!1,this.canvas.addEventListener("pointerdown",this._handlePointerDown,{passive:!1})}_handleMouseEvents(){this._drawingStroke=!1,this.canvas.addEventListener("mousedown",this._handleMouseDown,{passive:!1})}_handleTouchEvents(){this.canvas.addEventListener("touchstart",this._handleTouchStart,{passive:!1})}_reset(e){this._lastPoints=[],this._lastVelocity=0,this._lastWidth=(e.minWidth+e.maxWidth)/2,this._ctx.fillStyle=e.penColor,this._ctx.globalCompositeOperation=e.compositeOperation}_createPoint(e,n,s){const o=this.canvas.getBoundingClientRect();return new t(e-o.left,n-o.top,s,(new Date).getTime())}_addPoint(t,n){const{_lastPoints:s}=this;if(s.push(t),s.length>2){3===s.length&&s.unshift(s[0]);const t=this._calculateCurveWidths(s[1],s[2],n),o=e.fromPoints(s,t);return s.shift(),o}return null}_calculateCurveWidths(e,t,n){const s=n.velocityFilterWeight*t.velocityFrom(e)+(1-n.velocityFilterWeight)*this._lastVelocity,o=this._strokeWidth(s,n),i={end:o,start:this._lastWidth};return this._lastVelocity=s,this._lastWidth=o,i}_strokeWidth(e,t){return Math.max(t.maxWidth/(e+1),t.minWidth)}_drawCurveSegment(e,t,n){const s=this._ctx;s.moveTo(e,t),s.arc(e,t,n,0,2*Math.PI,!1),this._isEmpty=!1}_drawCurve(e,t){const n=this._ctx,o=e.endWidth-e.startWidth,s=2*Math.ceil(e.length());n.beginPath(),n.fillStyle=t.penColor;for(let c=0;c<s;c+=1){const n=c/s,l=n*n,d=l*n,i=1-n,u=i*i,h=u*i;let a=h*e.startPoint.x;a+=3*u*n*e.control1.x,a+=3*i*l*e.control2.x,a+=d*e.endPoint.x;let r=h*e.startPoint.y;r+=3*u*n*e.control1.y,r+=3*i*l*e.control2.y,r+=d*e.endPoint.y;const m=Math.min(e.startWidth+d*o,t.maxWidth);this._drawCurveSegment(a,r,m)}n.closePath(),n.fill()}_drawDot(e,t){const n=this._ctx,s=t.dotSize>0?t.dotSize:(t.minWidth+t.maxWidth)/2;n.beginPath(),this._drawCurveSegment(e.x,e.y,s),n.closePath(),n.fillStyle=t.penColor,n.fill()}_fromData(e,n,s){for(const a of e){const{points:i}=a,o=this._getPointGroupOptions(a);if(i.length>1)for(let e=0;e<i.length;e+=1){const s=i[e],r=new t(s.x,s.y,s.pressure,s.time);0===e&&this._reset(o);const a=this._addPoint(r,o);a&&n(a,o)}else this._reset(o),s(i[0],o)}}toSVG({includeBackgroundColor:e=!1,includeDataUrl:t=!1}={}){const a=this._data,s=Math.max(window.devicePixelRatio||1,1),o=this.canvas.width/s,i=this.canvas.height/s,n=document.createElementNS("http://www.w3.org/2000/svg","svg");if(n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("viewBox",`0 0 ${o} ${i}`),n.setAttribute("width",o.toString()),n.setAttribute("height",i.toString()),e&&this.backgroundColor){const e=document.createElement("rect");e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttribute("fill",this.backgroundColor),n.appendChild(e)}if(t&&this._dataUrl){const t=this._dataUrlOptions?.ratio||window.devicePixelRatio||1,s=this._dataUrlOptions?.width||this.canvas.width/t,o=this._dataUrlOptions?.height||this.canvas.height/t,i=this._dataUrlOptions?.xOffset||0,a=this._dataUrlOptions?.yOffset||0,e=document.createElement("image");e.setAttribute("x",i.toString()),e.setAttribute("y",a.toString()),e.setAttribute("width",s.toString()),e.setAttribute("height",o.toString()),e.setAttribute("preserveAspectRatio","none"),e.setAttribute("href",this._dataUrl),n.appendChild(e)}return this._fromData(a,(e,{penColor:t})=>{const s=document.createElement("path");if(!(isNaN(e.control1.x)||isNaN(e.control1.y)||isNaN(e.control2.x)||isNaN(e.control2.y))){const o=`M ${e.startPoint.x.toFixed(3)},${e.startPoint.y.toFixed(3)} C ${e.control1.x.toFixed(3)},${e.control1.y.toFixed(3)} ${e.control2.x.toFixed(3)},${e.control2.y.toFixed(3)} ${e.endPoint.x.toFixed(3)},${e.endPoint.y.toFixed(3)}`;s.setAttribute("d",o),s.setAttribute("stroke-width",(2.25*e.endWidth).toFixed(3)),s.setAttribute("stroke",t),s.setAttribute("fill","none"),s.setAttribute("stroke-linecap","round"),n.appendChild(s)}},(e,{penColor:t,dotSize:s,minWidth:o,maxWidth:i})=>{const a=document.createElement("circle"),r=s>0?s:(o+i)/2;a.setAttribute("r",r.toString()),a.setAttribute("cx",e.x.toString()),a.setAttribute("cy",e.y.toString()),a.setAttribute("fill",t),n.appendChild(a)}),n.outerHTML}};function e3(){const t=new Blob(['var g=[],l=[],C=["\\u{1F37F}","\\u{1F33D}","\\u{1F964}","\\u{1F968}","\\u{1FAD0}","\\u{1F363}"],z=["\\u2728","\\u2B50\\uFE0F","\\u{1F4A5}","\\u{1F31F}","\\u{1F525}","\\u{1F4AB}"],T=["\\u{1F680}","\\u{1F9E8}","\\u{1F4A3}","\\u{1FA84}","\\u{1F6F8}"],p=new Map,c,r,u,d;self.onmessage=async e=>{e.data.type==="init"?(c=e.data.canvas,r=c.getContext("2d"),u=c.width,d=c.height,await I([...C,...z,...T]),requestAnimationFrame(S)):e.data.type==="spawn"?k(e.data.options):e.data.type==="resize"&&(u=e.data.width,d=e.data.height,c.width=u,c.height=d)};async function E(e,n=64){let t=new OffscreenCanvas(n,n),i=t.getContext("2d");return i.font=`${n}px serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(e,n/2,n/2),await createImageBitmap(t)}async function I(e,n=64){for(let t of e)if(typeof t=="string"){if(!p.has(t)){let i=await E(t,n);p.set(t,i)}}else t instanceof ImageBitmap?p.has(t)||p.set(t,t):console.warn("Unsupported emoji item:",t)}function k(e){let{particleType:n="popcorn",originX:t=u/2,originY:i=d/2,count:h=20,size:f=30,minSpeed:m=5,maxSpeed:b=10,angle:y=-Math.PI/2,angleVariance:x=Math.PI/6,gravity:v=.2,lifeTime:M=100,fade:w=!0,explosionOptions:j={}}=e;if(n==="popcorn")for(let a=0;a<h;a++){let o=m+Math.random()*(b-m),s=y+(Math.random()-.5)*x,O=C[Math.floor(Math.random()*C.length)];l.push({type:"emoji",emoji:O,size:f,x:t,y:i,vx:Math.cos(s)*o,vy:Math.sin(s)*o,gravity:v,age:0,lifeTime:M,fade:w})}else if(n==="rocket")for(let a=0;a<h;a++){let o=m+Math.random()*(b-m),s=y+(Math.random()-.5)*x,O=T[Math.floor(Math.random()*T.length)];g.push({emoji:O,x:t,y:i,vx:Math.cos(s)*o,vy:Math.sin(s)*o,gravity:v,age:0,lifeTime:M,size:f,explosionOptions:j})}}function B(e,n,t={}){let{count:i=20,size:h=20,minSpeed:f=2,maxSpeed:m=7,angle:b=0,angleVariance:y=Math.PI*2,gravity:x=.1,lifeTime:v=80,fade:M=!0,emojiList:w=z}=t;for(let j=0;j<i;j++){let a=f+Math.random()*(m-f),o=b+(Math.random()-.5)*y,s=w[Math.floor(Math.random()*w.length)];l.push({type:"emoji",emoji:s,x:e,y:n,vx:Math.cos(o)*a,vy:Math.sin(o)*a,gravity:x,age:0,lifeTime:v,fade:M,size:h})}}function P(){for(let e=g.length-1;e>=0;e--){let n=g[e];n.vy+=n.gravity,n.x+=n.vx,n.y+=n.vy,n.age++,n.age>=n.lifeTime&&(B(n.x,n.y,n.explosionOptions),g.splice(e,1))}for(let e=l.length-1;e>=0;e--){let n=l[e];n.vy+=n.gravity,n.x+=n.vx,n.y+=n.vy,n.age++,n.age>=n.lifeTime&&l.splice(e,1)}}function A(){r.clearRect(0,0,u,d);for(let e of g){let n=p.get(e.emoji);n&&(r.globalAlpha=1,r.drawImage(n,e.x-e.size/2,e.y-e.size/2,e.size,e.size))}for(let e of l){let n=p.get(e.emoji);if(n){let t=e.fade?1-e.age/e.lifeTime:1;r.globalAlpha=t,r.drawImage(n,e.x-e.size/2,e.y-e.size/2,e.size,e.size),r.globalAlpha=1}}}function S(){P(),A(),requestAnimationFrame(S)}\n'],{type:"text/javascript"}),e=URL.createObjectURL(t),n=new Worker(e);return URL.revokeObjectURL(e),n}playPanel=document.getElementById("playPanel"),infoPanel=document.getElementById("infoPanel"),countPanel=document.getElementById("countPanel"),scorePanel=document.getElementById("scorePanel"),tegakiPanel=document.getElementById("tegakiPanel"),canvasCache=document.createElement("canvas").getContext("2d",{alpha:!1,willReadFrequently:!0}),canvases=[...tegakiPanel.getElementsByTagName("canvas")],gameTime=180,emojiParticle=initEmojiParticle(),correctCount=0,pads=[],problems=[],answered=!1,answer="ゴファー",firstRun=!0,audioBufferCache={},japaneseVoices=[],loadVoices(),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function createAudioContext(){return globalThis.AudioContext?new globalThis.AudioContext:(console.error("Web Audio API is not supported in this browser"),null)}function unlockAudio(){audioContext?audioContext.resume():(audioContext=createAudioContext(),loadAudio("end","mp3/end.mp3"),loadAudio("correct","mp3/correct3.mp3")),document.removeEventListener("click",unlockAudio),document.removeEventListener("keydown",unlockAudio)}async function loadAudio(e,t){if(!audioContext)return;if(audioBufferCache[e])return audioBufferCache[e];try{const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}catch(t){throw console.error(`Loading audio ${e} error:`,t),t}}function playAudio(e,t){if(!audioContext)return;const o=audioBufferCache[e];if(!o){console.error(`Audio ${e} is not found in cache`);return}const n=audioContext.createBufferSource();n.buffer=o;const s=audioContext.createGain();t&&(s.gain.value=t),s.connect(audioContext.destination),n.connect(s),n.start()}function loadVoices(){const e=new Promise(e=>{let t=speechSynthesis.getVoices();if(t.length!==0)e(t);else{let n=!1;speechSynthesis.addEventListener("voiceschanged",()=>{n=!0,t=speechSynthesis.getVoices(),e(t)}),setTimeout(()=>{n||document.getElementById("noTTS").classList.remove("d-none")},1e3)}});e.then(e=>{japaneseVoices=e.filter(e=>e.lang=="ja-JP")})}function loopVoice(e,t){speechSynthesis.cancel(),e=new Array(t).fill(`${e}。`).join(" ");const n=new globalThis.SpeechSynthesisUtterance(e);n.voice=japaneseVoices[Math.floor(Math.random()*japaneseVoices.length)],n.lang="ja-JP",speechSynthesis.speak(n)}function respeak(){loopVoice(answer,3)}function initEmojiParticle(){const e=document.createElement("canvas");Object.assign(e.style,{position:"fixed",pointerEvents:"none",top:"0px",left:"0px"}),e.width=document.documentElement.clientWidth,e.height=document.documentElement.clientHeight,document.body.appendChild(e);const t=e.transferControlToOffscreen(),n=e3();return n.postMessage({type:"init",canvas:t},[t]),globalThis.addEventListener("resize",()=>{const e=document.documentElement.clientWidth,t=document.documentElement.clientHeight;n.postMessage({type:"resize",width:e,height:t})}),{canvas:e,offscreen:t,worker:n}}function setTegakiPanel(){const e=document.getElementById("tegakiPanel");for(;e.firstChild;)e.removeChild(e.lastChild);pads=[];for(let t=0;t<answer.length;t++){const n=createTegakiBox();e.appendChild(n)}const t=e.children;canvases=[...t].map(e=>e.querySelector("canvas"))}function showPredictResult(e,t){const i=canvases.indexOf(e),s=answer[i];let o=!1;for(let e=0;e<t.length;e++)if(t[e]==s){o=!0;break}o?e.setAttribute("data-predict",s):e.setAttribute("data-predict",t[0]);let n="";for(let e=0;e<canvases.length;e++){const t=canvases[e].getAttribute("data-predict");t?n+=t:n+=" "}return document.getElementById("reply").textContent=n,n}function initSignaturePad(e){const t=new s(e,{minWidth:2,maxWidth:2,penColor:"black",backgroundColor:"white",throttle:0,minDistance:0});return t.addEventListener("endStroke",()=>{predict(t.canvas)}),t}function getImageData(e){const n=28,s=28;canvasCache.drawImage(e,0,0,n,s);const o=canvasCache.getImageData(0,0,n,s),t=o.data;for(let e=0;e<t.length;e+=4)t[e]=255-t[e],t[e+1]=255-t[e+1],t[e+2]=255-t[e+2];return o}function predict(e){const t=getImageData(e),n=canvases.indexOf(e);worker.postMessage({imageData:t,pos:n})}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e)+e)}function hideAnswer(){const e=document.getElementById("answer");e.classList.add("d-none")}function showAnswer(){const e=document.getElementById("answer");e.classList.remove("d-none"),e.textContent=answer}function nextProblem(){answered=!1;const e=document.getElementById("searchButton");e.disabled=!0,setTimeout(()=>{e.disabled=!1},2e3);const[t,n]=problems[getRandomInt(0,problems.length-1)],s=document.getElementById("cse-search-input-box-id");s.value=n,answer=t,document.getElementById("reply").textContent="",document.getElementById("mode").textContent=="EASY"?showAnswer():hideAnswer(),document.getElementById("wordLength").textContent=answer.length,loopVoice(answer,3)}async function initProblems(){const e=document.getElementById("grade").selectedIndex,t=e==0?"hira":"kana",n=await fetch(t+".lst"),s=await n.text();problems=[],s.trimEnd().split(`
`).forEach(e=>{const[t,n]=e.split("	");problems.push([t,n])})}function searchByGoogle(e){e.preventDefault();const t=document.getElementById("cse-search-input-box-id"),n=google.search.cse.element.getElement("searchresults-only0");return nextProblem(),t.value==""?n.clearAllResults():n.execute(t.value),setTegakiPanel(),firstRun&&(document.getElementById("gophers").replaceChildren(),document.getElementById("searchResults").classList.remove("d-none"),firstRun=!1),!1}document.getElementById("cse-search-box-form-id").onsubmit=searchByGoogle;function startGameTimer(){clearInterval(gameTimer);const e=document.getElementById("time");initTime(),gameTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(gameTimer),playAudio("end"),playPanel.classList.add("d-none"),scorePanel.classList.remove("d-none"),document.getElementById("score").textContent=correctCount)},1e3)}function countdown(){loopVoice("Ready",1),countPanel.classList.remove("d-none"),infoPanel.classList.add("d-none"),playPanel.classList.add("d-none"),scorePanel.classList.add("d-none");const e=document.getElementById("counter");e.textContent=3;const t=setInterval(()=>{const n=["skyblue","greenyellow","violet","tomato"];if(parseInt(e.textContent)>1){const t=parseInt(e.textContent)-1;e.style.backgroundColor=n[t],e.textContent=t}else clearInterval(t),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),playPanel.classList.remove("d-none"),correctCount=0,document.getElementById("score").textContent=correctCount,document.getElementById("searchButton").classList.add("animate__heartBeat"),startGameTimer()},1e3)}function initTime(){document.getElementById("time").textContent=gameTime}function changeMode(e){e.target.textContent=="EASY"?e.target.textContent="HARD":e.target.textContent="EASY"}TegakiBox=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.adoptedStyleSheets=[globalCSS];const e=document.getElementById("tegaki-box").content.cloneNode(!0),t=e.querySelector("use"),s=t.getAttribute("href").slice(1),o=document.getElementById(s).firstElementChild.cloneNode(!0);t.replaceWith(o),this.shadowRoot.appendChild(e);const i=this.shadowRoot.querySelector("canvas"),n=initSignaturePad(i);this.shadowRoot.querySelector(".eraser").onclick=()=>{n.clear()},pads.push(n),document.documentElement.getAttribute("data-bs-theme")=="dark"&&this.shadowRoot.querySelector("canvas").setAttribute("style","filter: invert(1) hue-rotate(180deg);")}},customElements.define("tegaki-box",TegakiBox);function createTegakiBox(){const e=document.createElement("div"),n=document.getElementById("tegaki-box").content.cloneNode(!0);e.appendChild(n);const s=e.querySelector("canvas"),t=initSignaturePad(s);return e.querySelector(".eraser").onclick=()=>{t.clear()},pads.push(t),e}function kanaToHira(e){return e.replace(/[ァ-ヶ]/g,e=>{const t=e.charCodeAt(0)-96;return String.fromCharCode(t)})}function hiraToKana(e){return e.replace(/[ぁ-ゖ]/g,e=>{const t=e.charCodeAt(0)+96;return String.fromCharCode(t)})}function formatReply(e){if(document.getElementById("grade").selectedIndex==1){if(["へ","べ","ぺ"].includes(e))return hiraToKana(e)}else if(["ヘ","ベ","ペ"].includes(e))return kanaToHira(e);return e}function getGlobalCSS(){let e="";for(const t of document.styleSheets)try{for(const n of t.cssRules)e+=n.cssText}catch{}const t=new CSSStyleSheet;return t.replaceSync(e),t}globalCSS=getGlobalCSS(),canvases.forEach(e=>{const t=initSignaturePad(e);pads.push(t),e.parentNode.querySelector(".eraser").onclick=()=>{t.clear(),showPredictResult(e," ")}}),worker=new Worker("worker.js"),worker.addEventListener("message",e=>{const t=e.data;if(pads[t.pos].toData().length==0)return;if(answered)return;const n=showPredictResult(canvases[t.pos],t.result);if(answer==formatReply(n)){if(answered=!0,document.getElementById("mode").textContent=="EASY")correctCount+=1;else{const e=document.getElementById("answer"),t=e.classList.contains("d-none");t&&(correctCount+=1)}playAudio("correct",.3),document.getElementById("reply").textContent="⭕ "+answer,document.getElementById("searchButton").classList.add("animate__heartBeat"),console.log(correctCount);for(let e=0;e<correctCount;e++)emojiParticle.worker.postMessage({type:"spawn",options:{particleType:"popcorn",originX:Math.random()*emojiParticle.canvas.width,originY:Math.random()*emojiParticle.canvas.height}})}}),await initProblems(),document.getElementById("mode").onclick=changeMode,document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("respeak").onclick=respeak,document.getElementById("restartButton").onclick=countdown,document.getElementById("startButton").onclick=countdown,document.getElementById("showAnswer").onclick=showAnswer,document.getElementById("grade").onchange=initProblems,document.getElementById("searchButton").addEventListener("animationend",e=>{e.target.classList.remove("animate__heartBeat")}),document.addEventListener("pointerdown",()=>{predict(canvases[0])},{once:!0}),document.addEventListener("click",unlockAudio,{once:!0}),document.addEventListener("keydown",unlockAudio,{once:!0})